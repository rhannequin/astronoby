# frozen_string_literal: true

module Astronoby
  module Util
    module Time
      OLD_LEAP_SECONDS = {
        2378496.5 => 13.188148343557259, # 1800-01-01T00:00:00+00:00
        2378677.5 => 12.977779959648615,
        2378861.5 => 12.789307379498496,
        2379042.5 => 12.627219619724201,
        2379226.5 => 12.484534330869792,
        2379407.5 => 12.364396579316235,
        2379591.5 => 12.261337343137711,
        2379772.5 => 12.1773053980869,
        2379956.5 => 12.108106397237862,
        2380138.5 => 12.054387758878875,
        2380322.5 => 12.013603253144538,
        2380503.5 => 11.98543684683682,
        2380687.5 => 11.96762962192588,
        2380868.5 => 11.959480197547236,
        2381052.5 => 11.959422685911704,
        2381233.5 => 11.966206580204016,
        2381417.5 => 11.978793920316093,
        2381599.5 => 11.99566047854023,
        2381783.5 => 12.015950798828271,
        2381964.5 => 12.037916332170425,
        2382148.5 => 12.061120228798245,
        2382329.5 => 12.083698914131674,
        2382513.5 => 12.10530703765835,
        2382694.5 => 12.12421078250918,
        2382878.5 => 12.140030777663924,
        2383060.5 => 12.151364887780801,
        2383244.5 => 12.157556479887717,
        2383425.5 => 12.15765329658825,
        2383609.5 => 12.150876665651595,
        2383790.5 => 12.136746181382478,
        2383974.5 => 12.114144526847667,
        2384155.5 => 12.083243093009514,
        2384339.5 => 12.042512500593148,
        2384521.5 => 11.992558943176846,
        2384705.5 => 11.931929977163236,
        2384886.5 => 11.862085932760237,
        2385070.5 => 11.78051543343463,
        2385251.5 => 11.689763871143441,
        2385435.5 => 11.586784825234645,
        2385616.5 => 11.474975813831406,
        2385800.5 => 11.350748372411545,
        2385982.5 => 11.21758410586699,
        2386166.5 => 11.072826269341022,
        2386347.5 => 10.920825074952518,
        2386531.5 => 10.756952695481232,
        2386712.5 => 10.587020134840714,
        2386896.5 => 10.405935512304495,
        2387077.5 => 10.22019193469896,
        2387261.5 => 10.024289426956784,
        2387443.5 => 9.824194633200023,
        2387627.5 => 9.616270032883222,
        2387808.5 => 9.406995099559936,
        2387992.5 => 9.190269937098492,
        2388173.5 => 8.974012950570796,
        2388357.5 => 8.751953043760295,
        2388538.5 => 8.532231137086455,
        2388722.5 => 8.308500055015429,
        2388904.5 => 8.087772834055613,
        2389088.5 => 7.866155700010495,
        2389269.5 => 7.650592317289465,
        2389453.5 => 7.434884049415814,
        2389634.5 => 7.226980347727022,
        2389818.5 => 7.020908291692649,
        2389999.5 => 6.824264827564548,
        2390183.5 => 6.631400447266969,
        2390365.5 => 6.448439782438527,
        2390549.5 => 6.272163832553815,
        2390730.5 => 6.1080329005421845,
        2390914.5 => 5.951314816355762,
        2391095.5 => 5.807762833132756,
        2391279.5 => 5.67321983816305,
        2391460.5 => 5.552603443019962,
        2391644.5 => 5.442394451603377,
        2391826.5 => 5.346096742151303,
        2392010.5 => 5.261939180030367,
        2392191.5 => 5.192368075351851,
        2392375.5 => 5.135275347080096,
        2392556.5 => 5.092642595328925,
        2392740.5 => 5.0631020675593845,
        2392921.5 => 5.047585133826715,
        2393105.5 => 5.045466038021345,
        2393287.5 => 5.056725300162157,
        2393471.5 => 5.0813396174220316,
        2393652.5 => 5.118191578710935,
        2393836.5 => 5.168077283418484,
        2394017.5 => 5.228879316252119,
        2394201.5 => 5.302037309391551,
        2394382.5 => 5.384531632259211,
        2394566.5 => 5.478379147577186,
        2394748.5 => 5.580335613932505,
        2394932.5 => 5.691789788972983,
        2395113.5 => 5.80875494138661,
        2395297.5 => 5.934144330408458,
        2395478.5 => 6.062875593983534,
        2395662.5 => 6.198153542957755,
        2395843.5 => 6.334486342631209,
        2396027.5 => 6.475251951900248,
        2396209.5 => 6.615483952215641,
        2396393.5 => 6.757060416676296,
        2396574.5 => 6.894941705629094,
        2396758.5 => 7.032466496923803,
        2396939.5 => 7.163937749348335,
        2397123.5 => 7.292473172750462,
        2397304.5 => 7.412673143453404,
        2397488.5 => 7.527299162998588,
        2397670.5 => 7.631984548218753,
        2397854.5 => 7.727845571025242,
        2398035.5 => 7.811233918589153,
        2398219.5 => 7.883805096017731,
        2398400.5 => 7.942151870516433,
        2398584.5 => 7.9871958259539895,
        2398765.5 => 8.016533772126351,
        2398949.5 => 8.030246708433822,
        2399131.5 => 8.02701838727982,
        2399315.5 => 8.00602743589197,
        2399496.5 => 7.967334857492741,
        2399680.5 => 7.909076736075594,
        2399861.5 => 7.832672030889775,
        2400045.5 => 7.73519070466137,
        2400226.5 => 7.619518664506842,
        2400410.5 => 7.4816235218118,
        2400592.5 => 7.324994613580456,
        2400776.5 => 7.146202934871676,
        2400957.5 => 6.9503926382285375,
        2401141.5 => 6.73130493384776,
        2401322.5 => 6.496419397354267,
        2401506.5 => 6.238403444540144,
        2401687.5 => 5.966222444405794,
        2401871.5 => 5.671527091411464,
        2402053.5 => 5.362950462274329,
        2402237.5 => 5.034600715553276,
        2402418.5 => 4.6965018330360175,
        2402602.5 => 4.3385322957757895,
        2402783.5 => 3.973519127096933,
        2402967.5 => 3.5906303869208167,
        2403148.5 => 3.2036725995868243,
        2403332.5 => 2.8012444581490232,
        2403514.5 => 2.3956847018984218,
        2403698.5 => 1.9796421127117891,
        2403879.5 => 1.5660461742034346,
        2404063.5 => 1.1428361434845933,
        2404244.5 => 0.7254582284581174,
        2404428.5 => 0.30178135991199984,
        2404609.5 => -0.11270006148430323,
        2404793.5 => -0.5300097435221406,
        2404975.5 => -0.9370907950094551,
        2405159.5 => -1.3412024731958803,
        2405340.5 => -1.7298134540480932,
        2405524.5 => -2.1142122995718458,
        2405705.5 => -2.480366366734088,
        2405889.5 => -2.83895781510422,
        2406070.5 => -3.176956105380124,
        2406254.5 => -3.504300154151409,
        2406436.5 => -3.8108248494746757,
        2406620.5 => -4.10223814009868,
        2406801.5 => -4.3699035350160695,
        2406985.5 => -4.621958792228032,
        2407166.5 => -4.849622707292203,
        2407350.5 => -5.060038124929611,
        2407531.5 => -5.2461236702027385,
        2407715.5 => -5.414009715942285,
        2407897.5 => -5.559113801802489,
        2408081.5 => -5.684979055402733,
        2408262.5 => -5.788896181101112,
        2408446.5 => -5.875063703703072,
        2408627.5 => -5.941604136061755,
        2408811.5 => -5.99187142911113,
        2408992.5 => -6.025534115559931,
        2409176.5 => -6.045223454604344,
        2409358.5 => -6.051947540372789,
        2409542.5 => -6.047693019280377,
        2409723.5 => -6.034585530924514,
        2409907.5 => -6.014253694220111,
        2410088.5 => -5.989451801657724,
        2410272.5 => -5.9615356388374785,
        2410453.5 => -5.933547174681333,
        2410637.5 => -5.9066933163237305,
        2410819.5 => -5.883732076789566,
        2411003.5 => -5.866053442239031,
        2411184.5 => -5.855727871403548,
        2411368.5 => -5.8537912883455165,
        2411549.5 => -5.861293927323844,
        2411733.5 => -5.879036033749507,
        2411914.5 => -5.906436546760297,
        2412098.5 => -5.9437407187970415,
        2412280.5 => -5.988588134352584,
        2412464.5 => -6.039608414140064,
        2412645.5 => -6.092048605632098,
        2412829.5 => -6.143066911075388,
        2413010.5 => -6.18519588086268,
        2413194.5 => -6.212372490839427,
        2413375.5 => -6.214734852478125,
        2413559.5 => -6.1812687926510375,
        2413741.5 => -6.0995165979128165,
        2413925.5 => -5.95200691711783,
        2414106.5 => -5.725411356266838,
        2414290.5 => -5.391101186767492,
        2414471.5 => -4.936214592188059,
        2414655.5 => -4.31790503046886,
        2414836.5 => -3.52545025806083,
        2415020.5 => -2.4388055967284674,
        2415201.5 => -1.9866921101473605,
        2415385.5 => -1.4881903065314066,
        2415566.5 => -0.9618691218134782,
        2415750.5 => -0.39284264593890794,
        2415931.5 => 0.19767418413824753,
        2416115.5 => 0.8264165244917904,
        2416296.5 => 1.4700172355479844,
        2416480.5 => 2.1468253465826375,
        2416662.5 => 2.835652766092306,
        2416846.5 => 3.5486047317343434,
        2417027.5 => 4.263231363098808,
        2417211.5 => 5.000259983924892,
        2417392.5 => 5.732816046006328,
        2417576.5 => 6.482353812962369,
        2417757.5 => 7.221751119829495,
        2417941.5 => 7.972880371561444,
        2418123.5 => 8.712831317161704,
        2418307.5 => 9.455454046423558,
        2418488.5 => 10.178387509185434,
        2418672.5 => 10.903463404820002,
        2418853.5 => 11.605090872859282,
        2419037.5 => 12.304684798828276,
        2419218.5 => 12.977775178916021,
        2419402.5 => 13.64513190798989,
        2419584.5 => 14.287108978143385,
        2419768.5 => 14.916572237369076,
        2419949.5 => 15.515510607554367,
        2420133.5 => 16.10284118737613,
        2420314.5 => 16.65863855961404,
        2420498.5 => 17.20068006434343,
        2420679.5 => 17.710794402822042,
        2420863.5 => 18.205520004226692,
        2421045.5 => 18.67098146138676,
        2421229.5 => 19.11729362430148,
        2421410.5 => 19.53253120288024,
        2421594.5 => 19.930579247056528,
        2421775.5 => 20.29868147462184,
        2421959.5 => 20.649370571074524,
        2422140.5 => 20.971627610669987,
        2422324.5 => 21.276649743274778,
        2422506.5 => 21.55655418126106,
        2422690.5 => 21.818167846062344,
        2422871.5 => 22.055281124221217,
        2423055.5 => 22.27655644857247,
        2423236.5 => 22.47561690120095,
        2423420.5 => 22.65996646290686,
        2423601.5 => 22.82452002838678,
        2423785.5 => 22.97571425952653,
        2423967.5 => 23.110308267157464,
        2424151.5 => 23.23229795912879,
        2424332.5 => 23.339511501395894,
        2424516.5 => 23.436563200676833,
        2424697.5 => 23.52133058525957,
        2424881.5 => 23.597688707429405,
        2425062.5 => 23.664184372246805,
        2425246.5 => 23.72407135482779,
        2425428.5 => 23.776681991877023,
        2425612.5 => 23.82419274912977,
        2425793.5 => 23.866331353902197,
        2425977.5 => 23.905460169259943,
        2426158.5 => 23.941218197004247,
        2426342.5 => 23.975692579033176,
        2426523.5 => 24.008605928439557,
        2426707.5 => 24.04187605377498,
        2426889.5 => 24.07537378002682,
        2427073.5 => 24.11058140261558,
        2427254.5 => 24.14721547072987,
        2427438.5 => 24.187142464135416,
        2427619.5 => 24.229652439984108,
        2427803.5 => 24.276712008407983,
        2427984.5 => 24.327284837979363,
        2428168.5 => 24.38350825339512,
        2428350.5 => 24.44430127350479,
        2428534.5 => 24.511366094895674,
        2428715.5 => 24.583145405760572,
        2428899.5 => 24.662288857343256,
        2429080.5 => 24.74643544094861,
        2429264.5 => 24.838554819441654,
        2429445.5 => 24.935777490385995,
        2429629.5 => 25.041422412562163,
        2429811.5 => 25.15273021858507,
        2429995.5 => 25.27216643328502,
        2430176.5 => 25.39641349476654,
        2430360.5 => 25.529540768204548,
        2430541.5 => 25.667128929194487,
        2430725.5 => 25.81363084582551,
        2430906.5 => 25.96413859864814,
        2431090.5 => 26.123484991687462,
        2431272.5 => 26.287217201519887,
        2431456.5 => 26.458739053598578,
        2431637.5 => 26.63313685630417,
        2431821.5 => 26.815971902751684,
        2432002.5 => 27.00105856424981,
        2432186.5 => 27.19429786593409,
        2432367.5 => 27.38915617204269,
        2432551.5 => 27.591855093366206,
        2432733.5 => 27.796691496947233,
        2432917.5 => 28.007936001208634,
        2433098.5 => 28.219596370060827,
        2433282.5 => 28.4384765624998,
        2433463.5 => 28.65724359589477,
        2433647.5 => 28.882964215782437,
        2433828.5 => 29.108113222396952,
        2434012.5 => 29.34000446979161,
        2434194.5 => 29.57223350574489,
        2434378.5 => 29.809796836408253,
        2434559.5 => 30.046134632450332,
        2434743.5 => 30.289022739879897,
        2434924.5 => 30.53050884062472,
        2435108.5 => 30.778591836086775,
        2435289.5 => 31.025202633417564,
        2435473.5 => 31.27856475284625,
        2435655.5 => 31.53189044630176,
        2435839.5 => 31.79085168727164,
        2436020.5 => 32.04851687044061,
        2436204.5 => 32.31358519491181,
        2436385.5 => 32.57759273374779,
        2436569.5 => 32.84949938063994,
        2436750.5 => 33.12066519162579,
        2436934.5 => 33.40033242784773,
        2437116.5 => 33.68120412544363,
        2437300.5 => 33.96974573155137,
        2437481.5 => 34.258379750810946,
        2437665.5 => 34.5569937600327,
        2437846.5 => 34.85617296641749,
        2438030.5 => 35.16617185935229,
        2438211.5 => 35.47721532145181,
        2438395.5 => 35.799955711962184,
        2438577.5 => 36.12601075254611,
        2438761.5 => 36.46287982255012,
        2438942.5 => 36.801664953153704,
        2439126.5 => 37.1539031471541,
        2439307.5 => 37.50838994184596,
        2439491.5 => 37.877141110449884,
        2439672.5 => 38.24836458592608,
        2439856.5 => 38.634572113308195,
        2440038.5 => 39.02550887261282,
        2440222.5 => 39.42989718222407,
        2440403.5 => 39.83675728105027,
        2440587.5 => 40.25961253333708,
        2440768.5 => 40.68465798505122,
        2440952.5 => 41.12591019247293,
        2441133.5 => 41.568849508274525,
        2441317.5 => 42.02796103684432,
        2441499.5 => 42.49057858125434,
        2441683.5 => 42.966532268043466,
        2441864.5 => 43.442420967015096,
        2442048.5 => 43.93353617862613,
        2442229.5 => 44.42331491540972,
        2442413.5 => 44.92735455766797,
        2442594.5 => 45.428517738630035,
        2442778.5 => 45.942622367844706,
        2442960.5 => 46.454873246740135,
        2443144.5 => 46.97557507852889,
        2443325.5 => 47.489552682778594,
        2443509.5 => 48.012750281605804,
        2443690.5 => 48.52697224120766,
        2443874.5 => 49.048043614533526,
        2444055.5 => 49.557725033980205,
        2444239.5 => 50.0715895041767,
        2444421.5 => 50.574294001573435,
        2444605.5 => 51.0754922955166,
        2444786.5 => 51.56024559759862,
        2444970.5 => 52.04321620585506,
        2445151.5 => 52.50729086053434,
        2445335.5 => 52.966488008352826,
        2445516.5 => 53.4045449379355,
        2445700.5 => 53.83473382284683,
        2445882.5 => 54.24409727758939,
        2446066.5 => 54.64058576938987,
        2446247.5 => 55.01268563318263,
        2446431.5 => 55.37200611165099,
        2446612.5 => 55.706320752291504,
        2446796.5 => 56.02643064426229,
        2446977.5 => 56.321893441388966,
        2447161.5 => 56.602817056686035,
        2447343.5 => 56.8620766468739,
        2447527.5 => 57.106458937032585,
        2447708.5 => 57.330978845137,
        2447892.5 => 57.54513390577631,
        2448073.5 => 57.744507716448425,
        2448257.5 => 57.93896314871017,
        2448438.5 => 58.126022272994305,
        2448622.5 => 58.316598521993,
        2448804.5 => 58.51100219137879,
        2448988.5 => 58.72000281988949,
        2449169.5 => 58.94513761608323,
        2449353.5 => 59.20242227252311,
        2449534.5 => 59.492985772485554,
        2449718.5 => 59.83746411076572,
        2449899.5 => 60.236736812592426,
        2450083.5 => 60.717905576806515,
        2450265.5 => 61.2837935622083,
        2450449.5 => 61.96410528309934,
        2450630.5 => 62.7581330776884,
        2450814.5 => 62.966,
        2450995.5 => 63.284,
        2451179.5 => 63.467,
        2451360.5 => 63.664 # 1999-07-01T00:00:00+00:00
      }.freeze

      RECENT_LEAP_SECONDS = {
        2451544.5 => 63.829, # 2000-01-01T00:00:00+00:00
        2451726.5 => 63.980,
        2451910.5 => 64.091,
        2452091.5 => 64.212,
        2452275.5 => 64.300,
        2452456.5 => 64.413,
        2452640.5 => 64.473,
        2452821.5 => 64.551,
        2453005.5 => 64.574,
        2453187.5 => 64.653,
        2453371.5 => 64.688,
        2453552.5 => 64.799,
        2453736.5 => 64.845,
        2453917.5 => 64.989,
        2454101.5 => 65.146,
        2454282.5 => 65.341,
        2454466.5 => 65.457,
        2454648.5 => 65.629,
        2454832.5 => 65.777,
        2455013.5 => 65.951,
        2455197.5 => 66.070,
        2455378.5 => 66.241,
        2455562.5 => 66.325,
        2455743.5 => 66.475,
        2455927.5 => 66.603,
        2456109.5 => 66.771,
        2456293.5 => 66.907,
        2456474.5 => 67.127,
        2456658.5 => 67.281,
        2456839.5 => 67.486,
        2457023.5 => 67.644,
        2457204.5 => 67.861,
        2457388.5 => 68.102,
        2457570.5 => 68.396,
        2457754.5 => 68.593,
        2457935.5 => 68.824,
        2458119.5 => 68.968,
        2458300.5 => 69.113,
        2458484.5 => 69.220,
        2458665.5 => 69.358,
        2458849.5 => 69.361,
        2459031.5 => 69.424,
        2459215.5 => 69.359,
        2459396.5 => 69.351,
        2459580.5 => 69.294,
        2459761.5 => 69.253,
        2459945.5 => 69.204,
        2460126.5 => 69.220,
        2460310.5 => 69.175,
        2460492.5 => 69.188,
        2460676.5 => 69.138,
        2460857.5 => 69.139 # 2025-07-01T00:00:00+00:00
      }.freeze

      OLDEST_JD = 2378496.5
      FIRST_RECENT_JD = 2451544.5
      MOST_RECENT_JD = 2460857.5

      # @param date [Date]
      # @param decimal [Numeric] Hour of the day, in decimal hours
      # @return [::Time] Date and time
      def self.decimal_hour_to_time(date, utc_offset, decimal)
        absolute_hour = decimal.abs
        hour = absolute_hour.floor

        unless hour.between?(0, Constants::HOURS_PER_DAY)
          raise(
            IncompatibleArgumentsError,
            "Hour must be between 0 and #{Constants::HOURS_PER_DAY.to_i}, got #{hour}"
          )
        end

        decimal_minute = Constants::MINUTES_PER_HOUR * (absolute_hour - hour)
        absolute_decimal_minute = (
          Constants::MINUTES_PER_HOUR * (absolute_hour - hour)
        ).abs
        minute = decimal_minute.floor
        second = Constants::SECONDS_PER_MINUTE *
          (absolute_decimal_minute - absolute_decimal_minute.floor)

        date_in_local_time = ::Time
          .utc(date.year, date.month, date.day, hour, minute, second)
          .getlocal(utc_offset)
          .to_date

        if date_in_local_time < date
          date = date.next_day
        elsif date_in_local_time > date
          date = date.prev_day
        end

        ::Time.utc(date.year, date.month, date.day, hour, minute, second).round
      end

      # @param instant [Numeric, Time, Date, DateTime]
      # @return [Integer, Float] Number of leap seconds for the given instant
      def self.terrestrial_universal_time_delta(instant)
        # Source:
        #  Title: Astronomical Algorithms
        #  Author: Jean Meeus
        #  Edition: 2nd edition
        #  Chapter: 10 - Dynamical Time and Universal Time

        jd = case instant
        when Numeric
          instant
        when ::Time, ::Date, ::DateTime
          JulianDate.from_time(instant)
        else
          raise IncompatibleArgumentsError,
            "Expected a Numeric, Time, Date or DateTime object, got #{instant.class}"
        end

        return RECENT_LEAP_SECONDS[MOST_RECENT_JD] if jd >= MOST_RECENT_JD
        return 0 if jd < OLDEST_JD

        if jd >= FIRST_RECENT_JD
          closest_jd = RECENT_LEAP_SECONDS.keys.bsearch { |key| key >= jd }
          leap_seconds = RECENT_LEAP_SECONDS[closest_jd]
        else
          closest_jd = OLD_LEAP_SECONDS.keys.bsearch { |key| key >= jd }
          leap_seconds = OLD_LEAP_SECONDS[closest_jd]
        end

        return leap_seconds if leap_seconds

        0.0
      end
    end
  end
end
